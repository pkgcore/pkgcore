#!/usr/bin/env pkgcore-ebuild-helper
# Copyright: 2011 Brian Harring <ferringb@gmail.com>
# License: GPL2/BSD 3 clause

recursive=false
if [[ ${1} == -r ]] ; then
	recursive=true
	shift
fi

check_args 1 -

if [[ "${INSDESTTREE%${D}*}" == "" ]]; then
	pkgcore_helper_exit 2 "do not give \${D} as part of the pathways to doins"
fi

install_paths()
{
	local mydir=$1
	shift
	check_command invoke_script dodir "${mydir}" || return 1

	for x in "$@"; do
		mysrc="${x}"
		if ! ${PKGCORE_DOINS_ALLOW_SYMLINKS}; then
			if [[ -L $x ]]; then
				check_command cp "$x" "${T}" || continue
				mysrc="${T}/${x##*/}"
			elif [[ -d $x ]] ; then
				$recursive || continue
				pushd "$x" &> /dev/null
				if directory_is_empty "${x}"; then
					install_paths "${mydir}/${x##*/}"
				else
					install_paths "${mydir}/${x##*/}" "${x}"/*
				fi
				popd &> /dev/null
				continue
			fi
		fi
		check_command install ${INSOPTIONS} "${mysrc}" "${D}${mydir}"
		# cleanup the tempspace...
		[[ ${mysrc} != ${x} ]] && rm -f "${mysrc}"
	done
}
install_paths "${INSDESTTREE}" "$@"
